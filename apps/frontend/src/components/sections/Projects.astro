---
import { useTranslations, Languages } from '../../../i18n/ui';

import type { ProjectWithTechnologies } from "@portafolio/shared-types";
import Card from "../ui/card.astro";

const urlLang = Astro.url.pathname.split('/')[1];
const lang = (urlLang in Languages ? urlLang : 'es') as keyof typeof Languages;
const translations = useTranslations(lang);

const backendUrl = import.meta.env.BACKEND_URL;

let projects: ProjectWithTechnologies[] = [];
let error: string | null = null;

try {
  if (!backendUrl) {
    throw new Error("BACKEND_URL no est√° definida en las variables de entorno");
  }

  const response = await fetch(`${backendUrl}/api/projects?lang=${lang}`);
  
  if (!response.ok) {
    throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
  }
  
  projects = (await response.json()) as ProjectWithTechnologies[];

} catch (e) {
  error = e instanceof Error ? e.message : "Error desconocido";
  console.error("Error fetching projects from", backendUrl, ":", e);
}
---

<section id="projects" class="py-20 px-6 max-w-7xl mx-auto min-h-screen flex flex-col justify-center overflow-hidden">
  <h2 class="text-4xl font-bold text-center mb-16 bg-clip-text text-transparent bg-linear-to-r from-primary to-accent">
    {translations('projects_title')}
  </h2>

  {error && (
    <div class="test-error text-red-500 p-4 border border-red-500 rounded my-4">
      <p>{translations('projects_error')}</p>
      <span>{error}</span>
    </div>
  )}

  {projects.length === 0 && !error && <p class="text-center text-(--color-text-muted)">{translations('projects_empty')}</p>}

  <div class="embla relative" id="projects-carousel">
    <div class="embla__viewport overflow-hidden cursor-grab active:cursor-grabbing">
      <div class="embla__container flex items-start touch-pan-y md:ml-0 animate-nudge md:animate-none">
        {projects.map((project) => (
          <div class="embla__slide flex-[0_0_85%] md:flex-[0_0_45%] lg:flex-[0_0_30%] min-w-0 pl-6">
            <Card 
              title={project.title}
              description={project.summary || project.description || ""}
              image={project.main_image_url || undefined}
              url={project.live_demo_url || undefined}
              repo={project.repository_url || undefined}
              technologies={project.technologies.map(t => ({ name: t.name, icon: t.icon || '' }))}
              liveText={translations('projects_live')}
              repoText={translations('projects_repo')}
              readMoreText={translations('projects_read_more')}
              showLessText={translations('projects_show_less')}
            />
          </div>
        ))}
      </div>
    </div>
</section>

<style>
  @keyframes nudge {
    0% { transform: translateX(0); }
    20% { transform: translateX(-30px); }
    40% { transform: translateX(0); }
  }
  
  .animate-nudge {
    animation: nudge 2s ease-in-out 1;
    animation-delay: 1s;
  }
</style>

<script>
  import EmblaCarousel from 'embla-carousel';

  const initCarousel = () => {
    const emblaNode = document.getElementById('projects-carousel');
    const viewportNode = emblaNode?.querySelector('.embla__viewport') as HTMLElement;

    if (viewportNode) {
      const emblaApi = EmblaCarousel(viewportNode, { 
        loop: true,
        align: 'start',
        containScroll: 'trimSnaps'
      }); 
    }
  };

  initCarousel();

  document.addEventListener('astro:page-load', initCarousel);
</script>